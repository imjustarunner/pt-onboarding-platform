import axios from 'axios';
import FormData from 'form-data';

const VT_URL = 'https://www.virustotal.com/api/v3/files';
const VT_ANALYSIS = 'https://www.virustotal.com/api/v3/analyses';

class MalwareScanService {
  static isConfigured() {
    return !!process.env.VIRUSTOTAL_API_KEY;
  }

  static async scanBuffer(buffer) {
    if (!this.isConfigured()) {
      throw new Error('VirusTotal API key not configured');
    }

    const apiKey = process.env.VIRUSTOTAL_API_KEY;
    const form = new FormData();
    form.append('file', buffer, { filename: 'upload.bin' });

    const uploadRes = await axios.post(VT_URL, form, {
      headers: {
        'x-apikey': apiKey,
        ...form.getHeaders()
      },
      maxContentLength: Infinity,
      maxBodyLength: Infinity
    });

    const analysisId = uploadRes.data?.data?.id;
    if (!analysisId) {
      throw new Error('VirusTotal analysis id missing');
    }

    const analysisRes = await axios.get(`${VT_ANALYSIS}/${analysisId}`, {
      headers: { 'x-apikey': apiKey }
    });

    const stats = analysisRes.data?.data?.attributes?.stats || {};
    const malicious = Number(stats.malicious || 0);
    const suspicious = Number(stats.suspicious || 0);

    if (malicious > 0 || suspicious > 0) {
      return { status: 'infected', details: JSON.stringify(stats) };
    }
    return { status: 'clean', details: JSON.stringify(stats) };
  }
}

export default MalwareScanService;
